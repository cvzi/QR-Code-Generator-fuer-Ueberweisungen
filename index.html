<!DOCTYPE html>
  <!--

  Quick Response Code Generator für Überweisungen, Released under GPLv3

  The standard (Version 1.4) can be found here:
    Quick Response Code: Guidelines to Enable Data Capture for the Initiation of a SEPA Credit Transfer
    http://www.europeanpaymentscouncil.eu/index.cfm/knowledge-bank/epc-documents/quick-response-code-guidelines-to-enable-data-capture-for-the-initiation-of-a-sepa-credit-transfer/


    Copyright (C) 2020 cuzi (cuzi@openmail.cc)

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
  -->
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <title>QR Code Generator für Überweisungen</title>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/iban-qr-code@1.0.0/index.js"></script>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <script type="text/javascript">

const txt = {
  txt_h1: {
    de: 'QR Generator für Überweisungen',
    en: 'QR generator for bank transfers'
  },
  txt_h2beneficiary: {
    de: 'Begünstigter:',
    en: 'Payee:'
  },
  txt_h2transfer: {
    de: 'Überweisung',
    en: 'Transfer'
  },
  btn_generate: {
    de: 'QR Code erzeugen',
    en: 'Generate QR Code'
  },
  txt_h2qrcode: {
    de: 'QR Code (Quick Transfer Code und BezahlCode)',
    en: 'QR Code (Quick transfer code and BezahlCode)'
  },
  qrcanv: {
    de: 'Keine Canvas Unterstützung',
    en: 'No canvas support!'
  }
}

const formfields = {
  accountHolder: {
    de_short: 'Kontoinhaber',
    de_long: 'Name des Kontoinhabers (max. 70 Zeichen)',
    en_short: 'Account holder',
    en_long: 'Name of the Beneficiary (max. 70 characters)'
  },
  iban: {
    de_short: 'IBAN',
    de_long: 'International Bank Account Number des Begünstigten (max. 34 Zeichen)',
    en_short: 'IBAN',
    en_long: 'International Bank Account Number of Beneficiary (max. 34 characters)'
  },
  bic: {
    de_short: 'BIC',
    de_long: 'BIC des Zahlungsdienstleisters des Begünstigten (bei Unionsüberweisungen nicht nötig) (max. 11 Zeichen)',
    en_short: 'BIC',
    en_long: 'BIC of the Beneficiary Bank (optional for union transactions) (max. 11 characters)'
  },
  amount: {
    de_short: 'Betrag (in EUR)',
    de_long: '',
    en_short: 'Amount (EUR)',
    en_long: ''
  },
  purposeCode: {
    de_short: 'Zahlungsgrund (vierstellig)',
    de_long: 'Optionaler, vierstelliger Buchstabencode',
    en_short: 'Purpose code (four characters)',
    en_long: 'Optional: Purpose of the Credit Transfer'
  },
  reference: {
    de_short: 'Referenz',
    de_long: '(max. 35 Zeichen)',
    en_short: 'Creditor Reference',
    en_long: '(max. 35 characters)'
  },
  remittanceInformation: {
    de_short: 'Verwendungszeck',
    de_long: 'an den Begünstigten (max. 140 Zeichen)',
    en_short: 'Purpose of transfer',
    en_long: 'Remittance Information to the Beneficiary (max. 140 characters)'
  },
  note: {
    de_short: 'Notiz für den Absender',
    de_long: '(max. 70 Zeichen)',
    en_short: 'Note to originator',
    en_long: '(max. 70 characters)'
  }
}

function validateData (data) {
  if (data.ref.length > 0 && data.reason.length > 0) {
    window.alert('Error: EITHER reference OR reason')
    return false
  }
  return true
}

function composeData () {
  const data = {
    name: $('#inp_accountHolder').val(),
    iban: $('#inp_iban').val(),
    bic: $('#inp_bic').val(),
    amount: $('#inp_amount').val().replace(/,/, '.'),
    char: $('#inp_purposeCode').val(),
    ref: $('#inp_reference').val(),
    reason: $('#inp_remittanceInformation').val(),
    hint: $('#inp_note').val()
  }

  if (!validateData(data)) {
    return false
  }

  return data
}

function generateCode () {
  // generate data string
  const data = composeData()
  if (!data) return false
  const girocodeStr = girocode(data)
  const bezahlcodeStr = bezahlcode(data)
  $('#out_raw').html(girocodeStr.replace(/\n/g, '<br>') + '<hr><a href="' + bezahlcodeStr + '">' + bezahlcodeStr + '</a>')

  let size = document.documentElement.clientWidth / 3
  size = Math.max(200, Math.min(600, size))

  const qrGiroCode = new QRious({
    element: document.getElementById('out_qr_girocode')
  })
  qrGiroCode.set({
    background: 'white',
    foreground: 'black',
    padding: 25,
    size: size,
    level: 'H',
    value: girocodeStr
  })

  const qrBezahlCode = new QRious({
    element: document.getElementById('out_qr_bezahlcode')
  })
  qrBezahlCode.set({
    background: 'white',
    foreground: 'black',
    padding: 25,
    size: size,
    level: 'H',
    value: bezahlcodeStr
  })
}

$(document).ready(function () {
  const lang = document.location.search === '?en' ? 'en' : 'de'

  for (const id in txt) {
    $('#' + id).html(txt[id][lang])
  }

  for (const name in formfields) {
    $('#lbl_' + name).html(formfields[name][lang + '_short'])
    $('#lbl_' + name).attr('title', formfields[name][lang + '_long'])
    $('#inp_' + name).attr('title', formfields[name][lang + '_long'])
    $('#inp_' + name).change(generateCode)
  }

  $('#btn_generate').click(generateCode)

  // Test data
  $('#inp_accountHolder').val('Max Mustermann')
  $('#inp_iban').val('DE19123412341234123412')
  $('#inp_bic').val('DEZZZYYYXXX')
  $('#inp_amount').val('19.05')
  $('#inp_remittanceInformation').val('Testsubject')
  $('#btn_generate').click()
})

</script>
</head>

<body>
  <div>

    <a href="?en">English</a> - <a href="?de">Deutsch</a> - <a href="https://github.com/cvzi/QR-Code-Generator-fuer-Ueberweisungen">Source code</a>

    <h1 id="txt_h1"></h1>
    <div>

      <h2 id="txt_h2beneficiary"></h2>

      <div>
        <label id="lbl_accountHolder" for="inp_accountHolder"></label>

        <div>
          <input id="inp_accountHolder"
               name="inp_accountHolder"
               size="80"
               maxlength="70"
               required
               type="text" />
        </div>
      </div>

      <div>
        <label id="lbl_iban" for="inp_iban"></label>

        <div>
          <input id="inp_iban"
               name="iban"
               size="38"
               maxlength="34"
               required
               pattern="[A-Za-z]{2}[0-9]{2}[A-Za-z0-9]{8,30}"
               type="text" />
        </div>
      </div>

      <div>
        <label id="lbl_bic" for="inp_bic"></label>

        <div>
          <input id="inp_bic"
               name="bic"
               size="12"
               maxlength="11"
               pattern="[A-Za-z]{6}[A-Za-z2-9][A-Za-z0-9]([A-Za-z0-9]{3})?"
               type="text" />
        </div>
      </div>

      <h2 id="txt_h2transfer"></h2>

      <div>
        <label id="lbl_amount" for="inp_amount"></label>

        <div>
          EUR<input id="inp_amount"
               name="amount"
               size="10"
               min="0.01"
               step="0.01"
               type="number" />
        </div>
      </div>

      <div>
        <label id="lbl_purposeCode" for="inp_purposeCode"></label>

        <div>
          <input id="inp_purposeCode"
               name="purposeCode"
               size="5"
               maxlength="4"
               type="text" />
        </div>
      </div>

      <div>
        <label id="lbl_reference" for="inp_reference"></label>

        <div>
          <input id="inp_reference"
               name="reference"
               size="39"
               maxlength="35"
               type="text" />
        </div>
      </div>

      <div>
        <label id="lbl_remittanceInformation" for="inp_remittanceInformation"></label>

        <div>
          <input id="inp_remittanceInformation"
               name="remittanceInformation"
               size="90"
               maxlength="140"
               type="text" />
        </div>
      </div>

      <div>
        <label id="lbl_note" for="inp_note"></label>

        <div>
          <input id="inp_note"
               name="note"
               size="80"
               maxlength="70"
               type="text" />
        </div>
      </div>

      <div>
        <button id="btn_generate" type="button"></button>
      </div>

      <h2 id="txt_h2qrcode"></h2>

      <div>
         <canvas id="out_qr_girocode"></canvas>
         <canvas id="out_qr_bezahlcode"></canvas>

      </div>

      <h2>Raw data:</h2>

      <div>
        <div style="font-family:monospace" id="out_raw"></div>
      </div>

    </div>

  </div>

</body>
</html>
